<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Our Messages</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#f5f5f5;
  font-family:'Segoe UI',sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#ff6b9d;
  color:#fff;
  padding:20px;
  text-align:center;
  font-size:1.8em;
  font-weight:600;
  cursor:pointer;
}
#messages{
  flex:1;
  padding:20px;
  overflow-y:auto;
  background:#fff;
  display:flex;
  flex-direction:column-reverse;
  gap:12px;
}
.message{
  max-width:80%;
  padding:14px 20px;
  border-radius:20px;
  line-height:1.5;
}
.you{
  background:#ff9a9e;
  color:#fff;
  align-self:flex-end;
  border-bottom-right-radius:4px;
}
.them{
  background:#e0e0e0;
  color:#000;
  align-self:flex-start;
  border-bottom-left-radius:4px;
}
.message img{
  max-width:220px;
  border-radius:14px;
  margin-top:6px;
}
.time{
  font-size:.8em;
  color:#555;
  margin-top:6px;
  text-align:right;
}
#inputArea{
  background:#fff;
  border-top:1px solid #eee;
  padding:15px;
  display:flex;
  gap:10px;
  align-items:center;
}
#msg{
  flex:1;
  padding:16px;
  border-radius:30px;
  border:1px solid #ddd;
  font-size:1.1em;
}
#send{
  background:#ff6b9d;
  color:#fff;
  width:50px;
  height:50px;
  border-radius:50%;
  border:none;
  font-size:1.4em;
  cursor:pointer;
}
#photo{
  font-size:1.4em;
  cursor:pointer;
}
input[type=file]{display:none}

/* PROFILE PANEL */
#profile{
  position:fixed;
  inset:0;
  background:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:40px;
  z-index:9999;
  text-align:center;
  display:none;
}
#profile img{
  width:120px;
  height:120px;
  object-fit:cover;
  border-radius:50%;
  margin:20px 0;
  border:4px solid #dbdbdb;
}
#profile input{
  margin:10px 0;
  padding:12px;
  width:80%;
  border:1px solid #dbdbdb;
  border-radius:10px;
  font-size:1.1em;
}
#profile button{
  background:#0095f6;
  color:#fff;
  padding:14px 40px;
  border:none;
  border-radius:8px;
  font-size:1.2em;
  cursor:pointer;
  margin-top:20px;
}
#closeProfile{
  position:absolute;
  top:20px;
  right:20px;
  font-size:1.8em;
  color:#999;
  cursor:pointer;
}
</style>
</head>

<body>
<header id="header">Our Messages</header>

<div id="messages"></div>

<div id="inputArea">
  <span id="photo">ðŸ“·</span>
  <input type="text" id="msg" placeholder="Type a messageâ€¦">
  <button id="send">âž¤</button>
</div>

<input type="file" id="photoUpload" accept="image/*">

<!-- PROFILE PANEL -->
<div id="profile">
  <span id="closeProfile">Ã—</span>
  <h1>Profile</h1>
  <img id="profilePhoto" src="https://via.placeholder.com/120/dbdbdb/000000?text=Photo">
  <input type="text" id="profileName" placeholder="Your Name">
  <input type="file" id="profileUpload" accept="image/*" style="display:none">
  <button id="changePhoto">Change Photo</button>
  <button id="saveProfile">Save</button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBBRAhMp-LMjS5hgzQNB48bz31AeBMAHDk",
  authDomain: "chatroom-3b44c.firebaseapp.com",
  databaseURL: "https://chatroom-3b44c-default-rtdb.firebaseio.com",
  projectId: "chatroom-3b44c",
  storageBucket: "chatroom-3b44c.firebasestorage.app",
  messagingSenderId: "222445358770",
  appId: "1:222445358770:web:c7fc0e4245308a8be943ab",
  measurementId: "G-NJVE8C8SZQ"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database().ref("messages");
const storage = firebase.storage();

/* ELEMENTS */
const messages = document.getElementById("messages");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const photoBtn = document.getElementById("photo");
const photoUpload = document.getElementById("photoUpload");

/* PROFILE ELEMENTS */
const header = document.getElementById("header");
const profile = document.getElementById("profile");
const profilePhoto = document.getElementById("profilePhoto");
const profileNameInput = document.getElementById("profileName");
const profileUpload = document.getElementById("profileUpload");
const changePhotoBtn = document.getElementById("changePhoto");
const saveProfileBtn = document.getElementById("saveProfile");
const closeProfileBtn = document.getElementById("closeProfile");

/* USER DATA */
let name = localStorage.getItem("myName") || "Promise of Love";
let photoURL = localStorage.getItem("myPhoto") || "https://via.placeholder.com/120/dbdbdb/000000?text=Photo";

/* SET PROFILE INFO */
header.textContent = name;
profilePhoto.src = photoURL;
profileNameInput.value = name;

/* PROFILE EVENTS */
header.onclick = () => profile.style.display = "flex";
closeProfileBtn.onclick = () => profile.style.display = "none";
changePhotoBtn.onclick = () => profileUpload.click();
profileUpload.onchange = e => {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => profilePhoto.src = ev.target.result;
  reader.readAsDataURL(file);
};
saveProfileBtn.onclick = () => {
  name = profileNameInput.value || "Promise of Love";
  photoURL = profilePhoto.src;
  localStorage.setItem("myName", name);
  localStorage.setItem("myPhoto", photoURL);
  header.textContent = name;
  profile.style.display = "none";
};

/* SEND MESSAGE FUNCTIONS */
function sendMessage(){
  const text = msgInput.value.trim(); if(!text) return;
  db.push({name,type:"text",text,photo:photoURL,time:Date.now()});
  msgInput.value = "";
}
sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage(); });

/* SEND PHOTO */
photoBtn.onclick = () => photoUpload.click();
photoUpload.onchange = e => {
  const file = e.target.files[0]; if(!file) return;
  const ref = storage.ref("photos/" + Date.now() + "_" + file.name);
  ref.put(file).then(()=> ref.getDownloadURL().then(url => {
    db.push({name,type:"photo",url,photo:photoURL,time:Date.now()});
  }));
};

/* LOAD MESSAGES WITH INFINITE SCROLL */
let lastKey = null;
let loadingOlder = false;

function loadMessages(initial=false){
  let query = db.orderByKey().limitToLast(20);
  if(lastKey && !initial) query = db.orderByKey().endBefore(lastKey).limitToLast(20);
  
  query.once("value", snap => {
    const fragment = document.createDocumentFragment();
    const msgs = [];
    snap.forEach(childSnap => { msgs.push({key: childSnap.key, val: childSnap.val()}); });
    msgs.reverse().forEach(m => {
      const div = document.createElement("div");
      div.className = `message ${m.val.name===name?"you":"them"}`;
      if(m.val.type==="photo"){
        const img = document.createElement("img");
        img.src = m.val.url;
        img.loading="lazy";
        div.appendChild(img);
      } else div.textContent = m.val.text;
      const t = document.createElement("div");
      t.className="time";
      t.textContent = new Date(m.val.time).toLocaleTimeString([], {hour:"numeric",minute:"2-digit"});
      div.appendChild(t);
      fragment.appendChild(div);
    });
    if(msgs.length>0) lastKey = msgs[0].key;
    messages.appendChild(fragment);
    if(initial) messages.scrollTop = messages.scrollHeight;
    loadingOlder = false;
  });
}

/* INITIAL LOAD */
loadMessages(true);

/* SCROLL UP TO LOAD OLDER */
messages.addEventListener("scroll", ()=>{
  if(messages.scrollTop<50 && !loadingOlder){
    loadingOlder=true;
    loadMessages();
  }
});

/* LISTEN FOR NEW MESSAGES */
db.limitToLast(1).on("child_added", snap=>{
  const m = snap.val();
  const div = document.createElement("div");
  div.className = `message ${m.name===name?"you":"them"}`;
  if(m.type==="photo"){
    const img = document.createElement("img");
    img.src = m.url;
    img.loading="lazy";
    div.appendChild(img);
  } else div.textContent = m.text;
  const t=document.createElement("div");
  t.className="time";
  t.textContent=new Date(m.time).toLocaleTimeString([], {hour:"numeric",minute:"2-digit"});
  div.appendChild(t);
  messages.prepend(div);
});
</script>
</body>
</html>